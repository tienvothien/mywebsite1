<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Scan v√† T·∫£i l√™n Google Drive</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        #video { width: 100%; max-height: 450px; background-color: #000; border: 2px solid #ccc; border-radius: 4px; }
        .controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; transition: background-color 0.3s; }
        #snap-button { background-color: #007bff; color: white; }
        #snap-button:hover { background-color: #0056b3; }
        #status-message { margin-top: 15px; font-weight: bold; }
        #preview { margin-top: 20px; text-align: center; }
        #preview-img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üì∑ Tr√¨nh Scan File B·∫±ng Camera</h2>
        
        <video id="video" autoplay playsinline></video>
        
        <div class="controls">
            <button id="snap-button">1. Ch·ª•p ·∫¢nh</button>
            <button id="upload-button" disabled style="background-color: #28a745; color: white;">2. T·∫£i l√™n Drive</button>
        </div>
        
        <p id="status-message">ƒêang ch·ªù k√≠ch ho·∫°t camera...</p>
        <div id="preview">
            <h3>·∫¢nh Xem Tr∆∞·ªõc:</h3>
            <img id="preview-img" alt="·∫¢nh ƒë√£ ch·ª•p">
        </div>
        
        <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapButton = document.getElementById('snap-button');
        const uploadButton = document.getElementById('upload-button');
        const previewImg = document.getElementById('preview-img');
        const statusMessage = document.getElementById('status-message');
        let capturedImageDataURL = null; // Bi·∫øn l∆∞u tr·ªØ ·∫£nh ƒë√£ ch·ª•p
        
        // --- C·∫•u h√¨nh Backend API ---
        // !!! C·∫ßn thay th·∫ø b·∫±ng URL c·ªßa Backend Server c·ªßa b·∫°n (v√≠ d·ª•: https://my-upload-server.render.com)
        const UPLOAD_API_ENDPOINT = 'http://localhost:3000/upload-to-drive'; 
        
        /**
         * 1. K√≠ch ho·∫°t Camera b·∫±ng WebRTC
         */
        function startCamera() {
            // Y√™u c·∫ßu camera sau (environment) tr√™n thi·∫øt b·ªã di ƒë·ªông
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            })
            .then(stream => {
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    statusMessage.textContent = "Camera ƒë√£ s·∫µn s√†ng. H√£y ch·ª•p ·∫£nh!";
                };
            })
            .catch(err => {
                console.error("L·ªói truy c·∫≠p camera: ", err);
                statusMessage.innerHTML = '‚ùå L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p v√† th·ª≠ l·∫°i.<br>(' + err.name + ')';
                snapButton.disabled = true;
            });
        }

        /**
         * 2. Ch·ª•p v√† Hi·ªÉn th·ªã ·∫¢nh
         */
        snapButton.addEventListener('click', () => {
            if (!video.srcObject) {
                statusMessage.textContent = "Camera ch∆∞a s·∫µn s√†ng.";
                return;
            }
            
            // ƒê·∫∑t k√≠ch th∆∞·ªõc canvas b·∫±ng k√≠ch th∆∞·ªõc th·ª±c c·ªßa video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const context = canvas.getContext('2d');
            
            // V·∫Ω khung h√¨nh hi·ªán t·∫°i c·ªßa video l√™n canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // T·∫†M TH·ªúI: X·ª≠ l√Ω scan c∆° b·∫£n (v√≠ d·ª•: chuy·ªÉn sang grayscale)
            // (Trong d·ª± √°n th·ª±c t·∫ø, sinh vi√™n n√™n d√πng th∆∞ vi·ªán nh∆∞ OpenCV.js ƒë·ªÉ c·∫Øt, s·ª≠a g√≥c)
            // const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            // applyGrayscaleFilter(imageData); // H√†m n√†y c·∫ßn ƒë∆∞·ª£c t·ª± ƒë·ªãnh nghƒ©a
            // context.putImageData(imageData, 0, 0);

            // L·∫•y d·ªØ li·ªáu ·∫£nh JPEG ch·∫•t l∆∞·ª£ng cao
            capturedImageDataURL = canvas.toDataURL('image/jpeg', 0.9); 
            
            // Hi·ªÉn th·ªã ·∫£nh xem tr∆∞·ªõc
            previewImg.src = capturedImageDataURL;
            previewImg.style.display = 'block';
            statusMessage.textContent = "·∫¢nh ƒë√£ ch·ª•p. B·∫°n c√≥ th·ªÉ T·∫£i l√™n Drive.";
            uploadButton.disabled = false; // K√≠ch ho·∫°t n√∫t T·∫£i l√™n
        });

        /**
         * 3. G·ª≠i ·∫¢nh l√™n Backend ƒë·ªÉ L∆∞u v√†o Google Drive
         */
        uploadButton.addEventListener('click', async () => {
            if (!capturedImageDataURL) {
                statusMessage.textContent = "Vui l√≤ng ch·ª•p ·∫£nh tr∆∞·ªõc.";
                return;
            }
            
            uploadButton.disabled = true;
            uploadButton.textContent = 'ƒêang t·∫£i l√™n...';
            statusMessage.textContent = "ƒêang g·ª≠i ·∫£nh ƒë·∫øn m√°y ch·ªß...";
            
            // T√°ch ph·∫ßn data Base64 ra kh·ªèi ti·ªÅn t·ªë 'data:image/jpeg;base64,'
            const base64Data = capturedImageDataURL.split(',')[1];
            
            try {
                const response = await fetch(UPLOAD_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: base64Data, // Ch·ªâ g·ª≠i Base64 Data
                        fileName: `scan_${new Date().toISOString()}.jpeg`
                    }),
                });

                const result = await response.json();

                if (response.ok) {
                    statusMessage.innerHTML = `‚úÖ **T·∫£i l√™n th√†nh c√¥ng!** ID Drive: ${result.fileId}`;
                    console.log("File uploaded:", result);
                } else {
                    statusMessage.innerHTML = `‚ùå **L·ªói T·∫£i l√™n:** ${result.error || response.statusText}`;
                }
            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi Backend:', error);
                statusMessage.innerHTML = '‚ùå **L·ªói K·∫øt n·ªëi:** Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß Backend.';
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = '2. T·∫£i l√™n Drive';
            }
        });

        // Kh·ªüi ƒë·ªông camera khi trang ƒë∆∞·ª£c t·∫£i
        startCamera();
    </script>
</body>
</html>
