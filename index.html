<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Scan T√†i Li·ªáu A4 (PDF Multi-page)</title>
    
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
    
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        #videoElement { width: 100%; max-height: 450px; background-color: #000; border: 2px solid #ccc; border-radius: 4px; }
        #canvasElement { display: none; } /* ·∫®n canvas th√¥ */
        .controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; transition: background-color 0.3s; }
        #scanButton { background-color: #007bff; color: white; }
        #uploadButton { background-color: #28a745; color: white; }
        #statusMessage { margin-top: 15px; font-weight: bold; }
        #counter { margin-top: 10px; font-size: 1.1em; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üìÑ Web Scan T√†i Li·ªáu A4</h2>
        
        <video id="videoElement" autoplay playsinline></video>
        
        <div class="controls">
            <button id="scanButton" disabled>Qu√©t Trang ƒê·∫ßu Ti√™n</button>
            <button id="uploadButton" style="display:none;" disabled>T·∫£i l√™n (0 Trang)</button>
        </div>
        
        <p id="counter">ƒê√£ qu√©t: 0 trang</p>
        <p id="statusMessage">ƒêang t·∫£i th∆∞ vi·ªán...</p>
        
        <canvas id="canvasElement" style="display:none;"></canvas>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const scanButton = document.getElementById('scanButton');
        const uploadButton = document.getElementById('uploadButton');
        const statusMessage = document.getElementById('statusMessage');
        const counter = document.getElementById('counter');

        let scannedPages = []; // M·∫£ng l∆∞u tr·ªØ Base64 data c·ªßa c√°c trang ƒë√£ qu√©t
        let cvReady = false; // Tr·∫°ng th√°i s·∫µn s√†ng c·ªßa OpenCV

        // --- C·∫•u h√¨nh Backend API ---
        // !!! THAY TH·∫æ b·∫±ng URL server c·ªßa b·∫°n sau khi tri·ªÉn khai server.js (v√≠ d·ª•: https://my-scan-server.onrender.com)
        const UPLOAD_API_ENDPOINT = 'http://localhost:3000/upload-pdf'; 
        
        // --- LOGIC KH·ªûI T·∫†O ---
        function onOpenCvReady() {
            cvReady = true;
            statusMessage.textContent = "‚úÖ Th∆∞ vi·ªán s·∫µn s√†ng. ƒêang k√≠ch ho·∫°t camera...";
            startCamera();
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            })
            .then(stream => {
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    statusMessage.textContent = "Camera ƒë√£ s·∫µn s√†ng. H√£y ƒë·∫∑t t√†i li·ªáu A4 v√†o khung h√¨nh.";
                    scanButton.disabled = false;
                };
            })
            .catch(err => {
                statusMessage.innerHTML = '‚ùå L·ªói Camera: Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.<br>(' + err.name + ')';
            });
        }
        
        // --- LOGIC SCAN (T√≠ch h·ª£p OpenCV) ---
        scanButton.addEventListener('click', scanDocument);

        async function scanDocument() {
            if (!cvReady || !video.srcObject) return;
            
            scanButton.disabled = true;
            scanButton.textContent = 'ƒêang x·ª≠ l√Ω...';
            statusMessage.textContent = 'ƒêang ti·∫øn h√†nh qu√©t v√† du·ªói th·∫≥ng t√†i li·ªáu A4...';

            // 1. Ch·ª•p ·∫£nh t·ª´ video l√™n canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                // 2. G·ªçi h√†m x·ª≠ l√Ω ·∫£nh OpenCV.js (Chi ti·∫øt h√†m n·∫±m d∆∞·ªõi)
                await scanDocumentA4(canvas);
                
                // 3. L·∫•y Base64 Data c·ªßa ·∫£nh ƒë√£ qu√©t B&W (ƒê√£ ƒë∆∞·ª£c du·ªói th·∫≥ng A4)
                const base64Data = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
                scannedPages.push(base64Data);
                
                // 4. C·∫≠p nh·∫≠t UI
                counter.textContent = `ƒê√£ qu√©t: ${scannedPages.length} trang`;
                statusMessage.textContent = `‚úÖ Qu√©t Trang ${scannedPages.length} th√†nh c√¥ng. Thay trang v√† qu√©t ti·∫øp.`;
                scanButton.textContent = 'Qu√©t Trang Ti·∫øp Theo';
                
                uploadButton.style.display = 'block';
                uploadButton.disabled = false;
                uploadButton.textContent = `T·∫£i l√™n (${scannedPages.length} Trang) & K·∫øt xu·∫•t PDF`;

            } catch (error) {
                statusMessage.textContent = '‚ùå L·ªói qu√©t ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.';
                console.error("Scanning Error:", error);
            } finally {
                scanButton.disabled = false;
            }
        }
        
        /**
         * H√ÄM X·ª¨ L√ù ·∫¢NH CHUY√äN S√ÇU B·∫∞NG OPENCV.JS
         * NOTE: ƒê·ªÉ ch·∫°y ho√†n ch·ªânh, sinh vi√™n c·∫ßn ƒëi·ªÅn logic t√¨m 4 g√≥c (B∆Ø·ªöC 1)
         * Hi·ªán t·∫°i, n√≥ ch·ªâ th·ª±c hi·ªán Perspective Transform d·ª±a tr√™n 4 g√≥c canvas (kh√¥ng ch√≠nh x√°c n·∫øu ch·ª•p nghi√™ng)
         */
        async function scanDocumentA4(canvas) {
            let src = cv.imread(canvas);
            let dst = new cv.Mat();
            
            // --- B∆Ø·ªöC 1: T√¨m 4 g√≥c t√†i li·ªáu (C·∫ßn sinh vi√™n t·ª± tri·ªÉn khai Canny, findContours, approxPolyDP) ---
            
            let width = src.cols;
            let height = src.rows;
            // T·∫°m th·ªùi d√πng 4 g√≥c canvas:
            let src_pts = [
                width, 0, 0, 0, 0, height, width, height // x1,y1, x2,y2, x3,y3, x4,y4
            ]; 

            // --- B∆Ø·ªöC 2: ƒê·ªãnh nghƒ©a k√≠ch th∆∞·ªõc ƒë·∫ßu ra theo T·ª∑ l·ªá A4 ---
            const A4_RATIO = Math.sqrt(2); 
            const TARGET_WIDTH = 1000; 
            const TARGET_HEIGHT = Math.round(TARGET_WIDTH * A4_RATIO); 

            let dst_pts = [
                0, 0, TARGET_WIDTH, 0, 
                0, TARGET_HEIGHT, TARGET_WIDTH, TARGET_HEIGHT 
            ];

            // --- B∆Ø·ªöC 3: Bi·∫øn ƒë·ªïi Ph·ªëi c·∫£nh (Perspective Transform) ---
            let M = cv.getPerspectiveTransform(
                cv.matFromArray(4, 1, cv.CV_32FC2, src_pts), 
                cv.matFromArray(4, 1, cv.CV_32FC2, dst_pts) 
            );
            
            cv.warpPerspective(src, dst, M, new cv.Size(TARGET_WIDTH, TARGET_HEIGHT));

            // --- B∆Ø·ªöC 4: L·ªçc ·∫£nh "Scan" (Black & White) ---
            cv.cvtColor(dst, dst, cv.COLOR_RGBA2GRAY, 0); 
            cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);

            // --- B∆Ø·ªöC 5: Hi·ªÉn th·ªã k·∫øt qu·∫£ l√™n Canvas ---
            cv.imshow(canvas, dst);
            
            // D·ªçn d·∫πp b·ªô nh·ªõ
            src.delete(); 
            dst.delete(); 
            M.delete();
        }


        // --- LOGIC UPLOAD PDF ---
        uploadButton.addEventListener('click', async () => {
            if (scannedPages.length === 0) return;
            
            uploadButton.disabled = true;
            uploadButton.textContent = `ƒêang t·∫£i l√™n ${scannedPages.length} trang...`;
            statusMessage.textContent = "ƒêang g·ª≠i ·∫£nh ƒë·∫øn m√°y ch·ªß ƒë·ªÉ k·∫øt xu·∫•t PDF v√† t·∫£i l√™n Drive...";
            
            try {
                const response = await fetch(UPLOAD_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pages: scannedPages, // M·∫£ng ·∫£nh Base64
                        sessionName: `ScanPDF_${new Date().toISOString().slice(0, 19).replace('T', '_')}`
                    }),
                });

                const result = await response.json();

                if (response.ok) {
                    statusMessage.innerHTML = `‚úÖ **T·∫£i l√™n PDF th√†nh c√¥ng!** File ID: ${result.fileId}`;
                    scannedPages = []; // Reset sau khi th√†nh c√¥ng
                    counter.textContent = "ƒê√£ qu√©t: 0 trang";
                    uploadButton.style.display = 'none';
                    scanButton.textContent = 'Qu√©t Trang ƒê·∫ßu Ti√™n';
                } else {
                    statusMessage.innerHTML = `‚ùå **L·ªói T·∫£i l√™n PDF:** ${result.error || response.statusText}`;
                }
            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi Backend:', error);
                statusMessage.innerHTML = '‚ùå **L·ªói K·∫øt n·ªëi:** Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß Backend.';
            } finally {
                uploadButton.disabled = false;
            }
        });
    </script>
</body>
</html>
